<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - MirageQueue Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-card { transition: transform 0.2s ease-in-out; }
        .dashboard-card:hover { transform: translateY(-2px); }
        .status-badge { font-weight: 600; text-transform: uppercase; font-size: 0.75rem; }
        .hero-section {
            background: linear-gradient(135deg, var(--bs-primary) 0%, var(--bs-secondary) 100%);
            color: white;
            padding: 4rem 2rem;
            border-radius: 0.375rem;
            margin-bottom: 2rem;
        }
        .icon-circle {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        /* Custom tooltip styles for message content */
        .tooltip {
            --bs-tooltip-max-width: 400px;
            font-size: 0.875rem;
        }
        
        .tooltip .tooltip-inner {
            text-align: left;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
            padding: 0.75rem;
        }
        
        .message-content-hover {
            cursor: help;
            border-bottom: 1px dotted var(--bs-secondary);
        }
        
        /* JSON formatting in tooltips */
        .json-tooltip {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
        }
    </style>
</head>
<body data-bs-theme="light">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg shadow-sm" data-bs-theme="inherit">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/mirage-dashboard">
                <i class="fas fa-stream me-2"></i>MirageQueue Dashboard
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/mirage-dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i>Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/mirage-dashboard/messages">
                            <i class="fas fa-envelope me-1"></i>Messages
                        </a>
                    </li>
                </ul>
                
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleTheme()" id="theme-toggle">
                    <i class="fas fa-sun" id="theme-icon"></i>
                    <span class="ms-1" id="theme-text">Light</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4">
        @RenderBody()
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <script>
        // HTMX Configuration
        htmx.config.globalViewTransitions = true;
        
        document.body.addEventListener('htmx:configRequest', function(evt) {
            evt.detail.headers['X-Requested-With'] = 'XMLHttpRequest';
        });

        // Bootstrap Theme Management (Light/Dark only)
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            // Update theme
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            document.body.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update button text and icon
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (newTheme === 'dark') {
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'Dark';
            } else {
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Light';
            }
        }

        // HTML escape utility
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // JSON prettification utility
        function prettifyJson(content, maxLength = 1000) {
            try {
                // Try to parse as JSON
                const parsed = JSON.parse(content);
                let formatted = JSON.stringify(parsed, null, 2);
                
                // Truncate if too long
                if (formatted.length > maxLength) {
                    formatted = formatted.substring(0, maxLength) + '\n...\n(truncated)';
                }
                
                return {
                    content: escapeHtml(formatted),
                    isJson: true
                };
            } catch (e) {
                // Not valid JSON, return as-is with truncation
                const truncated = content.length > maxLength ? 
                    content.substring(0, maxLength) + '\n...\n(truncated)' : 
                    content;
                
                return {
                    content: escapeHtml(truncated),
                    isJson: false
                };
            }
        }

        // Initialize Bootstrap tooltips
        function initTooltips() {
            // Dispose existing tooltips first
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                const tooltip = bootstrap.Tooltip.getInstance(el);
                if (tooltip) {
                    tooltip.dispose();
                }
            });
            
            // Initialize new tooltips
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                // Process message content tooltips
                if (el.classList.contains('message-content-hover')) {
                    const originalContent = el.getAttribute('data-bs-title');
                    const contentType = el.getAttribute('data-content-type');
                    
                    if (originalContent) {
                        const processed = prettifyJson(originalContent);
                        const tooltipClass = processed.isJson ? 'json-tooltip' : '';
                        
                        new bootstrap.Tooltip(el, {
                            html: true,
                            trigger: 'hover',
                            placement: 'auto',
                            delay: { show: 300, hide: 100 },
                            title: `<div class="${tooltipClass}">${processed.content}</div>`
                        });
                    }
                } else {
                    // Standard tooltips
                    new bootstrap.Tooltip(el, {
                        html: true,
                        trigger: 'hover',
                        placement: 'auto',
                        delay: { show: 300, hide: 100 }
                    });
                }
            });
        }

        // Load saved theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            document.body.setAttribute('data-bs-theme', savedTheme);
            
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (savedTheme === 'dark') {
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'Dark';
            } else {
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Light';
            }
            
            // Initialize tooltips
            initTooltips();
        });

        // Reinitialize tooltips after HTMX content updates
        document.body.addEventListener('htmx:afterSwap', function() {
            initTooltips();
        });
    </script>
</body>
</html>